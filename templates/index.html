<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BI Transition Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Add your custom styles here */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #primary-keys, #primary-keys-id, #er-diagram {
            margin-top: 20px;
        }
        #er-diagram img {
            max-width: 100%;
            height: auto;
            margin-bottom: 10px;
        }
        #download-btn {
            display: block;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header style="text-align: center;">
        <h1>BI Transition Tool</h1>
    </header>

    <main class="container">
        <section class="hero">
            <h2>Effortless Migration. Powerful Insights.</h2>
            <p>Seamlessly convert your Tableau dashboards to Power BI with our intuitive tools.</p>
            <form class="form-horizontal" action="" method="POST" enctype="multipart/form-data" id="upload-form">
                <center>
                    <input onchange="enableButton();" type="file" name="files[]" id="csv-upload" accept=".csv" multiple>
                    <br><br>
                    <button type="submit" class="btn btn-primary" id="get-started-btn" disabled>Get Started</button>
                    <button type="button" class="btn btn-danger" id="delete-files-btn" onclick="deleteFiles();">Refresh</button>
                </center>
            </form>
            <div id="status-message"></div>
            <div id="primary-keys"></div>
            <div id="primary-keys-id"></div>
            <div id="er-diagram" style="margin-top: 20px;">
                <div id="er-diagram-container"></div>
            </div>
        </section>

        <section class="features">
            <h2>Simplify Your Data Journey</h2>
            <div class="feature-card">
                <h3>ER Diagram Generator</h3>
                <p>Upload your CSV and generate a clear visual representation of your data relationships.</p>
            </div>
            <div class="feature-card">
                <h3>Chatbot-Powered Conversion</h3>
                <p>Our AI assistant helps you translate Tableau calculated fields to equivalent DAX expressions.</p>
            </div>
        </section>

        <section id="how-it-works">
            <h2>How it Works</h2>
            <div class="step">
                <h3>1. Primary Key</h3>
                <p>Start by uploading your CSV files and click on <i>Get Started</i> to obtain the potential primary keys.</p>
            </div>
            <div class="step">
                <h3>2. Entity Relationship Diagram</h3>
                <p>Our tool automatically generates an ER diagram for your files that can be downloaded by clicking on the link.</p>
            </div>
            <div class="step">
                <h3>3. Calculated Field Conversion</h3>
                <p>Use our AI assistant to effortlessly convert your Tableau calculated fields to Power BI DAX.</p>
            </div>
        </section>

        <section id="chatbot">
            <h2>DAX Generator</h2>
            <div id="chatbox">
                <div id="messages"></div>
                <form id="chat-form">
                    <input type="text" id="chat-input" placeholder="Enter your calculated field expression..." required>
                    <button type="submit" id="send-btn">Convert</button>
                </form>
            </div>
        </section>

        <section id="contact">
            <h2>Get in Touch</h2>
            <p>Have questions? Reach out to our team for expert assistance.</p>
            <a href="mailto:support@yourcompany.com">Contact Us</a>
        </section>

    </main>

    <script>
        document.getElementById('upload-form').addEventListener('submit', function(event) {
            event.preventDefault();

            var formData = new FormData();
            var files = document.getElementById('csv-upload').files;
            for (var i = 0; i < files.length; i++) {
                formData.append('files[]', files[i]);
            }

            fetch('/upload_csv', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    document.getElementById('status-message').textContent = data.message;
                } else {
                    displayPrimaryKeys(data.primary_keys);
                    displayPrimaryKeysId(data.primary_keys_id);
                    fetchErDiagramImage();
                }
            })
            .catch(error => {
                document.getElementById('status-message').textContent = 'Error uploading files: ' + error;
            });
        });

        function displayPrimaryKeys(primaryKeys) {
        var primaryKeysDiv = document.getElementById('primary-keys');
        primaryKeysDiv.innerHTML = '<h3>Candidate Keys</h3>';
        for (const [file, keys] of Object.entries(primaryKeys)) {
            primaryKeysDiv.innerHTML += `<p><strong>${file}</strong>: ${keys.join(', ')}</p>`;
        }
       }

            function displayPrimaryKeysId(primaryKeysId) {
                var primaryKeysIdDiv = document.getElementById('primary-keys-id');
                primaryKeysIdDiv.innerHTML = '<h3>Primary Keys</h3>';
                for (const [file, keys] of Object.entries(primaryKeysId)) {
                    primaryKeysIdDiv.innerHTML += `<p><strong>${file}</strong>: ${keys.join(', ')}</p>`;
                }
            }


        function fetchErDiagramImage() {
            var erDiagramContainer = document.getElementById('er-diagram-container');
            erDiagramContainer.innerHTML = '';

            fetch('/serve_er_diagram_png')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    } else {
                        throw new Error('Error fetching ER diagram image.');
                    }
                })
                .then(blob => {
                    var imageUrl = URL.createObjectURL(blob);
                    var img = document.createElement('img');
                    img.src = imageUrl;
                    img.alt = 'ER Diagram';
                    erDiagramContainer.appendChild(img);

                    var downloadBtn = document.createElement('a');
                    downloadBtn.href = imageUrl;
                    downloadBtn.download = 'er_diagram.png';
                    downloadBtn.textContent = 'Download ER Diagram';
                    downloadBtn.className = 'btn btn-primary';
                    erDiagramContainer.appendChild(downloadBtn);
                })
                .catch(error => {
                    document.getElementById('status-message').textContent = 'Error fetching ER diagram image: ' + error;
                });
        }

        function enableButton() {
            var uploadInput = document.getElementById('csv-upload');
            var getStartedBtn = document.getElementById('get-started-btn');
            if (uploadInput.files.length > 0) {
                getStartedBtn.disabled = false;
            } else {
                getStartedBtn.disabled = true;
            }
        }

        function deleteFiles() {
            fetch('/delete_files', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('status-message').textContent = data.message;
                document.getElementById('primary-keys').innerHTML = '';
                document.getElementById('primary-keys-id').innerHTML = '';
                document.getElementById('er-diagram-container').innerHTML = '';
                document.getElementById('csv-upload').value = '';
                document.getElementById('get-started-btn').disabled = true;
            })
            .catch(error => {
                document.getElementById('status-message').textContent = 'Error deleting files: ' + error;
            });
        }

        let chatId = null;

        document.getElementById('chat-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value;
            chatInput.value = '';

            if (!chatId) {
                fetch('/start_chat', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    chatId = data.chat_id;
                    sendMessage(chatId, message);
                })
                .catch(error => {
                    displayMessage('Error starting chat.');
                });
            } else {
                sendMessage(chatId, message);
            }
        });

        function sendMessage(chatId, message) {
            fetch('/convert_expression', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ chat_id: chatId, message: message })
            })
            .then(response => response.json())
            .then(data => {
                displayMessage('Input: ' + message);
                displayMessage('Output: ' + data.dax_expression);
            })
            .catch(error => {
                displayMessage('Error sending message.');
            });
        }

        function displayMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
        }
    </script>
</body>
</html>
